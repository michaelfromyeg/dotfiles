#!/usr/bin/env bash

# Universal shell configuration for bash and zsh

# History configuration
HISTSIZE=5000
HISTFILESIZE=5000
HISTCONTROL=ignoredups
HISTTIMEFORMAT="%F %T "

# Environment variables
export XDG_CONFIG_HOME="$HOME/.config"
export PATH="$HOME/bin:$PATH"
export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'
export RIPGREP_CONFIG_PATH="$HOME/.ripgreprc"
export EDITOR=zed

# Some common aliases
# Use eza if available, otherwise fall back to ls
if command -v eza >/dev/null 2>&1; then
  alias ls='eza --color=auto'
  alias ll='eza -alF --git'
  alias la='eza -a'
  alias l='eza -F'
  alias tree='eza --tree'
else
  alias ls='ls --color=auto'
  alias ll='ls -alF'
  alias la='ls -A'
  alias l='ls -CF'
fi

# Use bat if available
if command -v bat >/dev/null 2>&1; then
  alias cat='bat --paging=never'
fi
alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'
alias c='clear'

# (quick) git aliases; more in gitconfig
alias g='git'
alias ga='git add'
alias gaa='git add --all'
alias gc='git commit -v'
alias gcm='git commit -m'
alias gco='git checkout'
alias gcb='git checkout -b'
alias gd='git diff'
alias gl='git pull'
alias gp='git push'
alias gst='git status'
alias glg='git log --graph --oneline --decorate'
alias grh='git reset HEAD'
alias gsta='git stash'
alias gstp='git stash pop'
alias goc='git diff --name-only main...HEAD | xargs $EDITOR'

alias gtcom='gt co main'
alias gts='gt sync'
alias gtr='gt restack'
alias gtsub='gt submit --stack --update-only'

# Combines fzf and git add into a handy workflow
ga_fzf() {
  git status -s |
    fzf --multi --preview 'git diff --color=always {2}' --preview-window=right:70% |
    awk '{print $2}' |
    xargs -r git add
}
alias gaf='ga_fzf'

# Creates a new branch with a prefix (thank you @yash)
gnb_f() {
  if [ -z "$1" ]; then
    echo "Usage: gnb <branch-description>"
    echo "Example: gnb fix-login-bug"
    return 1
  fi

  git checkout -b "michaelfromyeg--$1"
  echo "Created and switched to branch: michaelfromyeg--$1"
}
alias gnb='gnb_f'

# Git worktree management functions
# Helper: Copy appropriate config files to new worktree
_gw_copy_configs() {
  local src="$1"
  local dest="$2"

  # Essential files (always copy if they exist)
  local essential_files=(".env" ".envrc" ".notion-cli.json" ".devex.config.yaml" "CLAUDE.local.md")

  for file in "${essential_files[@]}"; do
    if [ -f "$src/$file" ]; then
      cp "$src/$file" "$dest/$file"
      echo "  Copied: $file"
    fi
  done

  # VSCode settings
  if [ -d "$src/.vscode" ]; then
    mkdir -p "$dest/.vscode"
    for file in settings.json launch.json; do
      if [ -f "$src/.vscode/$file" ]; then
        cp "$src/.vscode/$file" "$dest/.vscode/$file"
        echo "  Copied: .vscode/$file"
      fi
    done
  fi

  # Zed settings
  if [ -d "$src/.zed" ]; then
    mkdir -p "$dest/.zed"
    for file in settings.json tasks.json; do
      if [ -f "$src/.zed/$file" ]; then
        cp "$src/.zed/$file" "$dest/.zed/$file"
        echo "  Copied: .zed/$file"
      fi
    done
  fi

  # Cursor MCP config
  if [ -f "$src/.cursor/mcp.json" ]; then
    mkdir -p "$dest/.cursor"
    cp "$src/.cursor/mcp.json" "$dest/.cursor/mcp.json"
    echo "  Copied: .cursor/mcp.json"
  fi

  # Claude local settings
  if [ -f "$src/.claude/settings.local.json" ]; then
    mkdir -p "$dest/.claude"
    cp "$src/.claude/settings.local.json" "$dest/.claude/settings.local.json"
    echo "  Copied: .claude/settings.local.json"
  fi
}

# Create a worktree at ../repo-name-X with config copying
gw_create_f() {
  if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: Not in a git repository"
    return 1
  fi

  if [ -z "$1" ]; then
    echo "Usage: gwc <branch-name>"
    return 1
  fi

  local branch_name="$1"
  local repo_root
  repo_root=$(git rev-parse --show-toplevel)
  local repo_name
  repo_name=$(basename "$repo_root")
  local parent_dir
  parent_dir=$(dirname "$repo_root")

  # Find next available number
  local counter=1
  while [ -d "$parent_dir/${repo_name}-${counter}" ]; do
    counter=$((counter + 1))
  done

  local worktree_path="$parent_dir/${repo_name}-${counter}"

  echo "Creating worktree at: $worktree_path"
  if git worktree add "$worktree_path" -b "$branch_name" 2>/dev/null ||
    git worktree add "$worktree_path" "$branch_name"; then
    _gw_copy_configs "$repo_root" "$worktree_path"

    # Run notion install-node-modules for notion-next repos
    if [ "$repo_name" = "notion-next" ]; then
      echo "Installing node modules for notion-next..."
      (cd "$worktree_path" && notion install-node-modules)
    fi

    echo "Worktree created: $worktree_path (branch: $branch_name)"
  else
    echo "Error: Failed to create worktree"
    return 1
  fi
}
alias gwc='gw_create_f'

# List worktrees (context-aware: repo or ~/code overview)
gw_list_f() {
  local code_dir="${HOME}/code"

  if git rev-parse --git-dir >/dev/null 2>&1; then
    # In a repo - show worktrees for this repo
    local repo_name
    repo_name=$(basename "$(git rev-parse --show-toplevel)")
    echo "Worktrees for $repo_name:"
    git worktree list --porcelain | awk '
      /^worktree/ { path=$2; has_branch=0 }
      /^branch/ {
        branch=$2
        gsub("refs/heads/", "", branch)
        printf "  %-50s %s\n", path, branch
        has_branch=1
      }
      /^$/ && !has_branch && path {
        printf "  %-50s (detached)\n", path
      }
    '
  elif [ "$(pwd)" = "$code_dir" ] || [[ "$(pwd)" == "$code_dir"* && ! -d ".git" ]]; then
    # In ~/code but not in a repo - show all repos
    echo "Repositories in $code_dir:"
    echo ""
    for dir in "$code_dir"/*/; do
      if [ -d "$dir/.git" ]; then
        local rname="$(basename "$dir")"
        local bname="$(git -C "$dir" branch --show-current 2>/dev/null || echo "(detached)")"
        local wtcount="$(git -C "$dir" worktree list 2>/dev/null | wc -l | tr -d ' ')"

        if [ "$wtcount" -gt 1 ]; then
          printf "%-30s %-25s (%d worktrees)\n" "$rname" "$bname" "$wtcount"
          git -C "$dir" worktree list 2>/dev/null | tail -n +2 | while read -r line; do
            printf "  └─ %-28s %s\n" "$(basename "$(echo "$line" | awk '{print $1}')")" "$(echo "$line" | awk '{print $3}' | tr -d '[]')"
          done
        else
          printf "%-30s %s\n" "$rname" "$bname"
        fi
      fi
    done
  else
    echo "Not in a git repository or ~/code directory"
    return 1
  fi
}
alias gwl='gw_list_f'

# Remove a worktree by path or name
gw_remove_f() {
  if [ -z "$1" ]; then
    echo "Usage: gwr <worktree-path-or-name>"
    echo "Example: gwr ../repo-name-1"
    echo "         gwr repo-name-1"
    return 1
  fi

  local target="$1"

  # If it's just a name, resolve relative to parent
  if [[ "$target" != /* && "$target" != ../* && "$target" != ./* ]]; then
    local repo_root
    repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
    if [ -n "$repo_root" ]; then
      local parent_dir
      parent_dir=$(dirname "$repo_root")
      target="$parent_dir/$target"
    fi
  fi

  if git worktree remove "$target" 2>/dev/null; then
    echo "Removed worktree: $target"
  else
    echo "Error: Failed to remove worktree. Try 'git worktree remove --force $target'"
    return 1
  fi
}
alias gwr='gw_remove_f'

# Sync configs from current worktree to all others
gw_sync_f() {
  if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: Not in a git repository"
    return 1
  fi

  local current_worktree
  current_worktree=$(git rev-parse --show-toplevel)

  local worktrees=()
  while IFS= read -r line; do
    if [[ "$line" == worktree\ * ]]; then
      local wt_path="${line#worktree }"
      if [ "$wt_path" != "$current_worktree" ]; then
        worktrees+=("$wt_path")
      fi
    fi
  done < <(git worktree list --porcelain)

  if [ ${#worktrees[@]} -eq 0 ]; then
    echo "No other worktrees to sync to"
    return 0
  fi

  echo "Syncing configs from: $current_worktree"
  echo ""
  for wt in "${worktrees[@]}"; do
    echo "→ $(basename "$wt")"
    _gw_copy_configs "$current_worktree" "$wt"
    echo ""
  done
  echo "Sync complete"
}
alias gws='gw_sync_f'

# Alert alias for long running commands
# Usage: sleep 10; alert
alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'\'')"'

# OS-specific configurations
case "$(uname -s)" in
Darwin*)
  # macOS-specific settings
  eval "$(/opt/homebrew/bin/brew shellenv)"
  export ANDROID_HOME="$HOME/Library/Android/sdk"
  ;;
Linux*)
  # Linux-specific settings
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  ;;
esac

# WSL-specific utilities
if grep -qi microsoft /proc/version 2>/dev/null; then
    # wslview replacement (wslu was discontinued)
    wslview() {
        if [ -z "$1" ]; then
            echo "Usage: wslview <file or url>"
            return 1
        fi

        if [ -e "$1" ]; then
            # It's a file - convert to Windows path
            cmd.exe /c start "" "$(wslpath -w "$1")" 2>/dev/null
        else
            # Assume it's a URL
            cmd.exe /c start "" "$1" 2>/dev/null
        fi
    }
fi

# Languages
# nvm (node version manager)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"                   # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion" # This loads nvm bash_completion

# Auto nvm use when entering directory with .nvmrc
_nvm_auto_use() {
  if [ -f ".nvmrc" ] && command -v nvm >/dev/null 2>&1; then
    nvm use --silent
  fi
}

# Use chpwd hook for zsh (works with zoxide's z command), cd wrapper for bash
if [ -n "$ZSH_VERSION" ]; then
  autoload -U add-zsh-hook
  add-zsh-hook chpwd _nvm_auto_use
else
  cd() {
    builtin cd "$@" && _nvm_auto_use
  }
fi

# Check on shell startup
_nvm_auto_use

# uv
export PATH="$HOME/.local/bin:$PATH"

# pyenv
export PYENV_ROOT="$HOME/.pyenv"
[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"

# rvm (ruby version manager)
export PATH="$PATH:$HOME/.rvm/bin"
[[ -s "$HOME/.rvm/scripts/rvm" ]] && source "$HOME/.rvm/scripts/rvm"

# sdkman (java, kotlin, gradle)
export SDKMAN_DIR="$HOME/.sdkman"
[[ -s "$SDKMAN_DIR/bin/sdkman-init.sh" ]] && source "$SDKMAN_DIR/bin/sdkman-init.sh"

# go
export PATH="/usr/local/go/bin:$HOME/go/bin:$PATH"

# asdf (erlang, elixir)
[ -f "$HOME/.asdf/asdf.sh" ] && source "$HOME/.asdf/asdf.sh"

# oh-my-posh (if installed)
if command -v oh-my-posh >/dev/null 2>&1; then
  # eval "$(oh-my-posh init "$(basename "$SHELL")" --config "$(brew --prefix oh-my-posh)"/themes/gruvbox.omp.json)"
  eval "$(oh-my-posh init "$(basename "$SHELL")" --config ~/.config/ohmyposh/gruvbox2.omp.json)"
fi

# rust
[ -f "$HOME/.cargo/env" ] && . "$HOME/.cargo/env"

# zoxide (smarter cd)
if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init "$(basename "$SHELL")")"
fi

# direnv (per-directory env vars)
if command -v direnv >/dev/null 2>&1; then
  eval "$(direnv hook "$(basename "$SHELL")")"
fi

# Notion-specific configurations (if needed)
if [ -d "$HOME/code/notion-next" ]; then
  alias nn="cd ~/code/notion-next"
  alias nn1="cd ~/code/notion-next-1"
  alias nn2="cd ~/code/notion-next-2"
  alias nn3="cd ~/code/notion-next-3"
  alias nr="notion run"
  alias nd="notion desktop run"
  alias ne="notion eslint"

  alias nfix="notion eslint --branch --fix --ratchet && notion format --branch && notion extract"
  alias ncheck="nfix && notion test --branch && notion typecheck --go"

  # Notion Android paths
  export PATH="$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin"

  # Notion shell completion
  if command -v notion >/dev/null 2>&1; then
    eval "$(notion completion --install)"
  fi

  # Run all modified test files on current branch vs main
  test-branch() {
    echo "Finding modified test files..."
    local test_files=$(git diff --name-only main...HEAD | grep '\.test\.tsx\?$')

    if [ -z "$test_files" ]; then
      echo "No modified test files found"
      return 0
    fi

    echo "Found test files:"
    echo "$test_files"
    echo ""

    echo "$test_files" | while read -r file; do
      if [ -f "$file" ]; then
        echo "========================================"
        echo "Testing: $file"
        echo "========================================"
        notion test "$file"
        echo ""
      fi
    done
  }
fi

# Gemini
export GOOGLE_CLOUD_PROJECT=assistant-vertex
export GOOGLE_CLOUD_LOCATION=us-central1
export GOOGLE_APPLICATION_CREDENTIALS="$HOME/gemini.json"

# Claude
if [ -x "$HOME/.claude/local/claude" ]; then
  alias claude="$HOME/.claude/local/claude"
fi
